<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Messenger - –¢–µ—Å—Ç–æ–≤—ã–π –∫–ª–∏–µ–Ω—Ç</title>
    <style>
        :root {
            --primary-color: #007bff;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --dark-color: #343a40;
            --light-color: #f8f9fa;
            --border-color: #dee2e6;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .app-title {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .app-title h1 {
            font-size: 24px;
            color: var(--primary-color);
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .status-badge {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .status-connected {
            background-color: var(--success-color);
            color: white;
        }
        
        .status-disconnected {
            background-color: var(--danger-color);
            color: white;
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 20px;
        }
        
        .panel {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .panel h2 {
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
            color: var(--dark-color);
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }
        
        input, textarea, select {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 14px;
        }
        
        button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.2s;
        }
        
        button:hover {
            background-color: #0056b3;
        }
        
        button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        
        .btn-success {
            background-color: var(--success-color);
        }
        
        .btn-success:hover {
            background-color: #218838;
        }
        
        .btn-danger {
            background-color: var(--danger-color);
        }
        
        .btn-danger:hover {
            background-color: #c82333;
        }
        
        .auth-forms {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        .users-list {
            max-height: 300px;
            overflow-y: auto;
        }
        
        .user-item {
            padding: 10px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .user-item:hover {
            background-color: #f8f9fa;
        }
        
        .user-item.active {
            background-color: #e3f2fd;
        }
        
        .online-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: var(--success-color);
        }
        
        .offline-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: #6c757d;
        }
        
        .chat-container {
            display: flex;
            flex-direction: column;
            height: 600px;
        }
        
        .chat-header {
            padding: 15px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .message {
            max-width: 70%;
            padding: 10px 15px;
            border-radius: 18px;
            position: relative;
        }
        
        .message-sent {
            align-self: flex-end;
            background-color: var(--primary-color);
            color: white;
        }
        
        .message-received {
            align-self: flex-start;
            background-color: #e9ecef;
            color: #333;
        }
        
        .message-info {
            font-size: 12px;
            margin-top: 5px;
            opacity: 0.7;
        }
        
        .typing-indicator {
            font-style: italic;
            color: #6c757d;
            padding: 5px 15px;
        }
        
        .chat-input {
            display: flex;
            padding: 15px;
            border-top: 1px solid var(--border-color);
            gap: 10px;
        }
        
        .chat-input textarea {
            flex: 1;
            resize: none;
            height: 60px;
        }
        
        .logs {
            max-height: 300px;
            overflow-y: auto;
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
        }
        
        .log-entry {
            margin-bottom: 5px;
            padding-bottom: 5px;
            border-bottom: 1px solid #e9ecef;
        }
        
        .log-time {
            color: #6c757d;
        }
        
        .log-success {
            color: var(--success-color);
        }
        
        .log-error {
            color: var(--danger-color);
        }
        
        .log-info {
            color: var(--primary-color);
        }
        
        .hidden {
            display: none;
        }
        
        .tabs {
            display: flex;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 15px;
        }
        
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
        }
        
        .tab.active {
            border-bottom: 2px solid var(--primary-color);
            font-weight: bold;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="app-title">
                <h1>üöÄ Messenger Test Client</h1>
                <div id="connection-status" class="status-badge status-disconnected">Disconnected</div>
            </div>
            <div class="user-info">
                <span id="user-display">Not authenticated</span>
                <button id="logout-btn" class="btn-danger hidden">Logout</button>
            </div>
        </header>

        <div class="main-content">
            <div class="left-panel">
                <!-- –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è -->
                <div class="panel">
                    <h2>Authentication</h2>
                    <div class="auth-forms">
                        <div>
                            <h3>Register</h3>
                            <div class="form-group">
                                <label for="register-name">Name</label>
                                <input type="text" id="register-name" placeholder="Your full name">
                            </div>
                            <div class="form-group">
                                <label for="register-username">Username</label>
                                <input type="text" id="register-username" placeholder="Unique username">
                            </div>
                            <div class="form-group">
                                <label for="register-password">Password</label>
                                <input type="password" id="register-password" placeholder="Strong password">
                            </div>
                            <button id="register-btn" class="btn-success">Register</button>
                        </div>
                        
                        <div>
                            <h3>Login</h3>
                            <div class="form-group">
                                <label for="login-username">Username</label>
                                <input type="text" id="login-username" placeholder="Your username">
                            </div>
                            <div class="form-group">
                                <label for="login-password">Password</label>
                                <input type="password" id="login-password" placeholder="Your password">
                            </div>
                            <button id="login-btn">Login</button>
                        </div>
                    </div>
                </div>

                <!-- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ -->
                <div class="panel" id="users-panel">
                    <h2>Users</h2>
                    <div class="users-list" id="users-list">
                        <!-- Users will be populated here -->
                    </div>
                </div>

                <!-- –õ–æ–≥–∏ -->
                <div class="panel">
                    <div class="tabs">
                        <div class="tab active" data-tab="system-log">System Log</div>
                        <div class="tab" data-tab="signalr-log">SignalR Log</div>
                    </div>
                    
                    <div class="tab-content active" id="system-log">
                        <div class="logs" id="system-logs">
                            <!-- System logs will appear here -->
                        </div>
                    </div>
                    
                    <div class="tab-content" id="signalr-log">
                        <div class="logs" id="signalr-logs">
                            <!-- SignalR logs will appear here -->
                        </div>
                    </div>
                </div>
            </div>

            <div class="right-panel">
                <!-- –ß–∞—Ç -->
                <div class="panel" id="chat-panel">
                    <h2>Chat</h2>
                    <div class="chat-container">
                        <div class="chat-header">
                            <span id="chat-with">Select a user to start chatting</span>
                            <div id="typing-indicator" class="typing-indicator hidden"></div>
                        </div>
                        <div class="chat-messages" id="chat-messages">
                            <!-- Messages will appear here -->
                        </div>
                        <div class="chat-input">
                            <textarea id="message-input" placeholder="Type your message here..." disabled></textarea>
                            <button id="send-btn" disabled>Send</button>
                        </div>
                    </div>
                </div>

                <!-- –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ API -->
                <div class="panel">
                    <h2>API Testing</h2>
                    <div class="form-group">
                        <button id="test-backend-btn">Test Backend Connection</button>
                        <button id="test-db-btn">Test Database Connection</button>
                        <button id="get-users-btn">Get All Users</button>
                    </div>
                    <div class="logs" id="api-logs" style="height: 150px;">
                        <!-- API test results will appear here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
        const API_BASE_URL = '/api';
        const SIGNALR_URL = '/chatHub';

        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let currentUser = null;
        let selectedUser = null;
        let signalRConnection = null;
        let typingTimer = null;

        // DOM —ç–ª–µ–º–µ–Ω—Ç—ã
        const connectionStatus = document.getElementById('connection-status');
        const userDisplay = document.getElementById('user-display');
        const logoutBtn = document.getElementById('logout-btn');
        const registerBtn = document.getElementById('register-btn');
        const loginBtn = document.getElementById('login-btn');
        const usersList = document.getElementById('users-list');
        const usersPanel = document.getElementById('users-panel');
        const chatPanel = document.getElementById('chat-panel');
        const chatWith = document.getElementById('chat-with');
        const chatMessages = document.getElementById('chat-messages');
        const messageInput = document.getElementById('message-input');
        const sendBtn = document.getElementById('send-btn');
        const typingIndicator = document.getElementById('typing-indicator');
        const systemLogs = document.getElementById('system-logs');
        const signalrLogs = document.getElementById('signalr-logs');
        const apiLogs = document.getElementById('api-logs');
        const testBackendBtn = document.getElementById('test-backend-btn');
        const testDbBtn = document.getElementById('test-db-btn');
        const getUsersBtn = document.getElementById('get-users-btn');

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', function() {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π —Ç–æ–∫–µ–Ω
            const token = localStorage.getItem('jwt_token');
            if (token) {
                // –ü—ã—Ç–∞–µ–º—Å—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–µ—Å—Å–∏—é
                restoreSession(token);
            } else {
                updateUIForUnauthenticated();
            }
            
            // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≤–∫–ª–∞–¥–æ–∫
            setupTabs();
            
            // –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –±—ç–∫–µ–Ω–¥–∞
            testBackendConnection();
        });

        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≤–∫–ª–∞–¥–æ–∫
        function setupTabs() {
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    // –£–±–∏—Ä–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å —É –≤—Å–µ—Ö –≤–∫–ª–∞–¥–æ–∫ –∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å –∫ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –≤–∫–ª–∞–¥–∫–µ –∏ –∫–æ–Ω—Ç–µ–Ω—Ç—É
                    tab.classList.add('active');
                    const tabId = tab.getAttribute('data-tab');
                    document.getElementById(tabId).classList.add('active');
                });
            });
        }

        // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
        function logSystem(message, type = 'info') {
            const time = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            logEntry.innerHTML = `<span class="log-time">[${time}]</span> ${message}`;
            systemLogs.appendChild(logEntry);
            systemLogs.scrollTop = systemLogs.scrollHeight;
        }

        function logSignalR(message, type = 'info') {
            const time = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            logEntry.innerHTML = `<span class="log-time">[${time}]</span> ${message}`;
            signalrLogs.appendChild(logEntry);
            signalrLogs.scrollTop = signalrLogs.scrollHeight;
        }

        function logApi(message, type = 'info') {
            const time = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            logEntry.innerHTML = `<span class="log-time">[${time}]</span> ${message}`;
            apiLogs.appendChild(logEntry);
            apiLogs.scrollTop = apiLogs.scrollHeight;
        }

        // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–µ—Å—Å–∏–∏ –ø–æ —Ç–æ–∫–µ–Ω—É
        async function restoreSession(token) {
            try {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å —Ç–æ–∫–µ–Ω–∞
                const response = await fetch(`${API_BASE_URL}/auth/verify`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const userData = await response.json();
                    currentUser = userData;
                    updateUIForAuthenticated();
                    connectToSignalR(token);
                    loadUsers();
                    logSystem('Session restored successfully', 'success');
                } else {
                    localStorage.removeItem('jwt_token');
                    updateUIForUnauthenticated();
                    logSystem('Session expired, please login again', 'error');
                }
            } catch (error) {
                localStorage.removeItem('jwt_token');
                updateUIForUnauthenticated();
                logSystem(`Error restoring session: ${error.message}`, 'error');
            }
        }

        // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
        registerBtn.addEventListener('click', async function() {
            const name = document.getElementById('register-name').value;
            const username = document.getElementById('register-username').value;
            const password = document.getElementById('register-password').value;
            
            if (!name || !username || !password) {
                alert('Please fill all fields');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}/auth/register`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ name, username, password })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    localStorage.setItem('jwt_token', data.token);
                    currentUser = data;
                    updateUIForAuthenticated();
                    connectToSignalR(data.token);
                    loadUsers();
                    logSystem(`User ${username} registered successfully`, 'success');
                    
                    // –û—á–∏—Å—Ç–∫–∞ —Ñ–æ—Ä–º—ã
                    document.getElementById('register-name').value = '';
                    document.getElementById('register-username').value = '';
                    document.getElementById('register-password').value = '';
                } else {
                    logSystem(`Registration failed: ${data.message || 'Unknown error'}`, 'error');
                    alert(`Registration failed: ${data.message || 'Unknown error'}`);
                }
            } catch (error) {
                logSystem(`Registration error: ${error.message}`, 'error');
                alert(`Registration error: ${error.message}`);
            }
        });

        // –í—Ö–æ–¥
        loginBtn.addEventListener('click', async function() {
            const username = document.getElementById('login-username').value;
            const password = document.getElementById('login-password').value;
            
            if (!username || !password) {
                alert('Please fill all fields');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ username, password })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    localStorage.setItem('jwt_token', data.token);
                    currentUser = data;
                    updateUIForAuthenticated();
                    connectToSignalR(data.token);
                    loadUsers();
                    logSystem(`User ${username} logged in successfully`, 'success');
                    
                    // –û—á–∏—Å—Ç–∫–∞ —Ñ–æ—Ä–º—ã
                    document.getElementById('login-username').value = '';
                    document.getElementById('login-password').value = '';
                } else {
                    logSystem(`Login failed: ${data.message || 'Unknown error'}`, 'error');
                    alert(`Login failed: ${data.message || 'Unknown error'}`);
                }
            } catch (error) {
                logSystem(`Login error: ${error.message}`, 'error');
                alert(`Login error: ${error.message}`);
            }
        });

        // –í—ã—Ö–æ–¥
        logoutBtn.addEventListener('click', function() {
            localStorage.removeItem('jwt_token');
            currentUser = null;
            selectedUser = null;
            
            if (signalRConnection) {
                signalRConnection.stop();
                signalRConnection = null;
            }
            
            updateUIForUnauthenticated();
            logSystem('Logged out successfully', 'info');
        });

        // –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ SignalR
        async function connectToSignalR(token) {
            try {
                // –ó–∞–≥—Ä—É–∂–∞–µ–º SignalR –∫–ª–∏–µ–Ω—Ç, –µ—Å–ª–∏ –µ—â–µ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω
                if (typeof signalR === 'undefined') {
                    await loadScript('https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/6.0.0/signalr.min.js');
                }
                
                // –°–æ–∑–¥–∞–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
                signalRConnection = new signalR.HubConnectionBuilder()
                    .withUrl(SIGNALR_URL, {
                        accessTokenFactory: () => token
                    })
                    .withAutomaticReconnect()
                    .build();
                
                // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π
                signalRConnection.on('ReceiveMessage', (message) => {
                    logSignalR(`Message received: ${message.body}`, 'info');
                    displayMessage(message, false);
                    
                    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–º–µ—á–∞–µ–º –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω–æ–µ, –µ—Å–ª–∏ —ç—Ç–æ —Ç–µ–∫—É—â–∏–π —á–∞—Ç
                    if (selectedUser && message.senderId === selectedUser.id) {
                        signalRConnection.invoke('MarkAsRead', message.id)
                            .then(() => logSignalR(`Message ${message.id} marked as read`, 'info'))
                            .catch(err => logSignalR(`Error marking message as read: ${err}`, 'error'));
                    }
                });
                
                signalRConnection.on('MessageSent', (data) => {
                    logSignalR(`Message sent successfully, ID: ${data.messageId}`, 'success');
                });
                
                signalRConnection.on('MessageRead', (messageId) => {
                    logSignalR(`Message ${messageId} was read by recipient`, 'info');
                    updateMessageStatus(messageId, 'read');
                });
                
                signalRConnection.on('UserTyping', (data) => {
                    if (selectedUser && data.userId === selectedUser.id) {
                        showTypingIndicator(data.isTyping);
                    }
                });
                
                signalRConnection.onreconnecting(() => {
                    connectionStatus.textContent = 'Reconnecting...';
                    connectionStatus.className = 'status-badge status-disconnected';
                    logSignalR('SignalR connection lost, reconnecting...', 'warning');
                });
                
                signalRConnection.onreconnected(() => {
                    connectionStatus.textContent = 'Connected';
                    connectionStatus.className = 'status-badge status-connected';
                    logSignalR('SignalR connection restored', 'success');
                });
                
                signalRConnection.onclose(() => {
                    connectionStatus.textContent = 'Disconnected';
                    connectionStatus.className = 'status-badge status-disconnected';
                    logSignalR('SignalR connection closed', 'error');
                });
                
                // –ó–∞–ø—É—Å–∫–∞–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
                await signalRConnection.start();
                connectionStatus.textContent = 'Connected';
                connectionStatus.className = 'status-badge status-connected';
                logSignalR('SignalR connection established', 'success');
                
            } catch (error) {
                connectionStatus.textContent = 'Connection Failed';
                connectionStatus.className = 'status-badge status-disconnected';
                logSignalR(`SignalR connection failed: ${error.message}`, 'error');
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        async function loadUsers() {
            try {
                const token = localStorage.getItem('jwt_token');
                const response = await fetch(`${API_BASE_URL}/users`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const users = await response.json();
                    renderUsersList(users);
                    logApi(`Loaded ${users.length} users`, 'success');
                } else {
                    logApi(`Failed to load users: ${response.status}`, 'error');
                }
            } catch (error) {
                logApi(`Error loading users: ${error.message}`, 'error');
            }
        }

        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        function renderUsersList(users) {
            usersList.innerHTML = '';
            
            users.forEach(user => {
                if (user.id === currentUser.id) return; // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                
                const userItem = document.createElement('div');
                userItem.className = 'user-item';
                userItem.dataset.userId = user.id;
                
                userItem.innerHTML = `
                    <div>
                        <strong>${user.name}</strong>
                        <div>@${user.userName}</div>
                    </div>
                    <div class="${user.isOnline ? 'online-indicator' : 'offline-indicator'}"></div>
                `;
                
                userItem.addEventListener('click', () => selectUser(user));
                usersList.appendChild(userItem);
            });
        }

        // –í—ã–±–æ—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è —á–∞—Ç–∞
        function selectUser(user) {
            // –°–Ω–∏–º–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            document.querySelectorAll('.user-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // –í—ã–¥–µ–ª—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            document.querySelector(`.user-item[data-user-id="${user.id}"]`).classList.add('active');
            
            selectedUser = user;
            chatWith.textContent = `Chat with ${user.name} (@${user.userName})`;
            
            // –û—á–∏—â–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –∏ –∑–∞–≥—Ä—É–∂–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é
            chatMessages.innerHTML = '';
            loadChatHistory(user.id);
            
            // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞
            messageInput.disabled = false;
            sendBtn.disabled = false;
            messageInput.focus();
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ —á–∞—Ç–∞
        async function loadChatHistory(userId) {
            try {
                const token = localStorage.getItem('jwt_token');
                const response = await fetch(`${API_BASE_URL}/messages/${userId}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const messages = await response.json();
                    messages.forEach(message => {
                        displayMessage(message, message.senderId === currentUser.id);
                    });
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                    logApi(`Loaded ${messages.length} messages`, 'success');
                } else {
                    logApi(`Failed to load chat history: ${response.status}`, 'error');
                }
            } catch (error) {
                logApi(`Error loading chat history: ${error.message}`, 'error');
            }
        }

        // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
        sendBtn.addEventListener('click', sendMessage);

        messageInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –Ω–∞–±–æ—Ä–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
        messageInput.addEventListener('input', function() {
            if (!signalRConnection || !selectedUser) return;
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–∏–≥–Ω–∞–ª –æ –Ω–∞—á–∞–ª–µ –Ω–∞–±–æ—Ä–∞
            signalRConnection.invoke('Typing', selectedUser.id, true)
                .catch(err => console.error('Error sending typing indicator:', err));
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ç–∞–π–º–µ—Ä
            clearTimeout(typingTimer);
            typingTimer = setTimeout(() => {
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–∏–≥–Ω–∞–ª –æ–± –æ–∫–æ–Ω—á–∞–Ω–∏–∏ –Ω–∞–±–æ—Ä–∞
                signalRConnection.invoke('Typing', selectedUser.id, false)
                    .catch(err => console.error('Error sending typing indicator:', err));
            }, 1000);
        });

        async function sendMessage() {
            const messageText = messageInput.value.trim();
            if (!messageText || !selectedUser || !signalRConnection) return;
            
            try {
                await signalRConnection.invoke('SendMessage', selectedUser.id, messageText);
                messageInput.value = '';
                
                // –û—á–∏—â–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –Ω–∞–±–æ—Ä–∞
                clearTimeout(typingTimer);
                signalRConnection.invoke('Typing', selectedUser.id, false)
                    .catch(err => console.error('Error sending typing indicator:', err));
                    
            } catch (error) {
                logSignalR(`Error sending message: ${error.message}`, 'error');
                alert(`Error sending message: ${error.message}`);
            }
        }

        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
        function displayMessage(message, isSent) {
            const messageElement = document.createElement('div');
            messageElement.className = `message ${isSent ? 'message-sent' : 'message-received'}`;
            messageElement.dataset.messageId = message.id;
            
            const time = new Date(message.sendTime).toLocaleTimeString();
            const status = isSent ? (message.isRead ? '‚úì‚úì' : '‚úì') : '';
            
            messageElement.innerHTML = `
                <div>${message.body}</div>
                <div class="message-info">${time} ${status}</div>
            `;
            
            chatMessages.appendChild(messageElement);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
        function updateMessageStatus(messageId, status) {
            const messageElement = document.querySelector(`[data-message-id="${messageId}"]`);
            if (messageElement) {
                const messageInfo = messageElement.querySelector('.message-info');
                if (status === 'read') {
                    messageInfo.textContent = messageInfo.textContent.replace('‚úì', '‚úì‚úì');
                }
            }
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –Ω–∞–±–æ—Ä–∞
        function showTypingIndicator(show) {
            if (show) {
                typingIndicator.textContent = `${selectedUser.name} is typing...`;
                typingIndicator.classList.remove('hidden');
            } else {
                typingIndicator.classList.add('hidden');
            }
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI –¥–ª—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        function updateUIForAuthenticated() {
            userDisplay.textContent = `${currentUser.name} (@${currentUser.userName})`;
            logoutBtn.classList.remove('hidden');
            usersPanel.classList.remove('hidden');
            chatPanel.classList.remove('hidden');
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI –¥–ª—è –Ω–µ–∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        function updateUIForUnauthenticated() {
            userDisplay.textContent = 'Not authenticated';
            logoutBtn.classList.add('hidden');
            usersPanel.classList.add('hidden');
            chatPanel.classList.add('hidden');
            connectionStatus.textContent = 'Disconnected';
            connectionStatus.className = 'status-badge status-disconnected';
            usersList.innerHTML = '';
            chatMessages.innerHTML = '';
            messageInput.disabled = true;
            sendBtn.disabled = true;
        }

        // –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –±—ç–∫–µ–Ω–¥–∞
        testBackendBtn.addEventListener('click', testBackendConnection);
        
        async function testBackendConnection() {
            try {
                const response = await fetch(`${API_BASE_URL}/test`);
                if (response.ok) {
                    const data = await response.json();
                    logApi(`Backend test: SUCCESS - ${data.message}`, 'success');
                } else {
                    logApi(`Backend test: FAILED - HTTP ${response.status}`, 'error');
                }
            } catch (error) {
                logApi(`Backend test: ERROR - ${error.message}`, 'error');
            }
        }

        testDbBtn.addEventListener('click', async function() {
            try {
                const response = await fetch(`${API_BASE_URL}/test/db`);
                if (response.ok) {
                    const data = await response.json();
                    logApi(`Database test: SUCCESS - ${data.database}`, 'success');
                } else {
                    logApi(`Database test: FAILED - HTTP ${response.status}`, 'error');
                }
            } catch (error) {
                logApi(`Database test: ERROR - ${error.message}`, 'error');
            }
        });

        getUsersBtn.addEventListener('click', async function() {
            try {
                const token = localStorage.getItem('jwt_token');
                if (!token) {
                    logApi('Please login first to get users', 'error');
                    return;
                }
                
                const response = await fetch(`${API_BASE_URL}/users`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const users = await response.json();
                    logApi(`Got ${users.length} users: ${users.map(u => u.userName).join(', ')}`, 'success');
                } else {
                    logApi(`Failed to get users: HTTP ${response.status}`, 'error');
                }
            } catch (error) {
                logApi(`Error getting users: ${error.message}`, 'error');
            }
        });

        // –ó–∞–≥—Ä—É–∑–∫–∞ –≤–Ω–µ—à–Ω–∏—Ö —Å–∫—Ä–∏–ø—Ç–æ–≤
        function loadScript(src) {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = src;
                script.onload = resolve;
                script.onerror = reject;
                document.head.appendChild(script);
            });
        }
    </script>
</body>
</html>